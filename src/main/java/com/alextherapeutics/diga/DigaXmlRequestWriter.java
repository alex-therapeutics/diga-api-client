package com.alextherapeutics.diga;

import com.alextherapeutics.diga.model.DigaCodeInformation;
import com.alextherapeutics.diga.model.xml.NachrichtentypStp;
import com.alextherapeutics.diga.model.xml.ObjectFactory;
import com.alextherapeutics.diga.model.xml.PruefungFreischaltcode;
import com.alextherapeutics.diga.model.xml.VerfahrenskennungStp;
import lombok.Builder;
import lombok.NonNull;
import lombok.extern.slf4j.Slf4j;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.datatype.DatatypeFactory;
import java.io.ByteArrayOutputStream;
import java.io.IOException;

/**
 * Creates XML data bodies for code validation requests.
 * Depends on beans generated by JAXB
 */
@Slf4j
public class DigaXmlRequestWriter {
    private String senderIk;
    private String digaId;

    private JAXBContext context;
    private Marshaller marshaller;
    private ObjectFactory objectFactory;
    private DatatypeFactory datatypeFactory;

    private static final String PRUEFUNG_VERSION = "002.000.000";
    private static final String PRUEFUNG_GUELTIGAB = "2020-07-01";

    @Builder
    public DigaXmlRequestWriter(@NonNull String senderIk, @NonNull String digaId) throws JAXBException {
        this.senderIk = DigaUtils.ikNumberWithoutPrefix(senderIk);
        this.digaId = digaId;
        init();
    }

    private void init() throws JAXBException {
        objectFactory = new ObjectFactory();
        context = JAXBContext.newInstance(PruefungFreischaltcode.class);
        marshaller = context.createMarshaller();
        marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);
        datatypeFactory = DatatypeFactory.newDefaultInstance();
    }

    /**
     * Return a byte array containing a PruefungFreischaltcode - Anfrage XML request
     * @return
     * @throws JAXBException
     * @throws IOException
     */
    public byte[] createCodeValidationRequest(DigaCodeInformation codeInformation) throws JAXBException, IOException {
        var processIdentifier = DigaUtils.isDigaTestCode(codeInformation.getFullDigaCode())
                ? VerfahrenskennungStp.TDFC_0
                : VerfahrenskennungStp.EDFC_0;


        var receiverIkWithoutPrefix = DigaUtils.ikNumberWithoutPrefix(codeInformation.getInsuranceCompanyIKNumber());
        var anfrage = objectFactory.createPruefungFreischaltcodeAnfrage();
        anfrage.setIKDiGAHersteller(senderIk);
        anfrage.setIKKrankenkasse(receiverIkWithoutPrefix);
        anfrage.setDiGAID(digaId);
        anfrage.setFreischaltcode(codeInformation.getFullDigaCode());

        var request = objectFactory.createPruefungFreischaltcode();
        request.setAnfrage(anfrage);
        request.setVerfahrenskennung(processIdentifier);
        request.setGueltigab(datatypeFactory.newXMLGregorianCalendar(PRUEFUNG_GUELTIGAB));
        request.setAbsender(senderIk);
        request.setEmpfaenger(receiverIkWithoutPrefix);
        request.setNachrichtentyp(NachrichtentypStp.ANF);
        request.setVersion(PRUEFUNG_VERSION);

        try (var res = new ByteArrayOutputStream()) {
            marshaller.marshal(request, res);
            return res.toByteArray();
        }
    }
}
